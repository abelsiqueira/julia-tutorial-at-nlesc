<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <link rel="stylesheet" href="/julia-tutorial-at-nlesc/libs/highlight/github.min.css">   
  <link href="/julia-tutorial-at-nlesc/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="icon" href="/julia-tutorial-at-nlesc/images/logo.png">
  <link rel="stylesheet" href="/julia-tutorial-at-nlesc/css/code-katex.css">
  <link rel="stylesheet" href="/julia-tutorial-at-nlesc/css/custom.css">
  <link rel="stylesheet" href="/julia-tutorial-at-nlesc/css/dark-mode.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel&family=Montserrat&display=swap" rel="stylesheet">
   <title></title>  

  <!-- Social media -->
  <meta property="og:title" content="Julia Tutorial at NLeSC">
  <meta name="twitter:title" content="Julia Tutorial at NLeSC">

  
  <meta property="og:description" content="">
  <meta name="twitter:description" content="">
  

  
  <meta property="og:image" content="https://abelsiqueira.github.io/images/abel-banner.jpg">
  <meta name="twitter:image" content="https://abelsiqueira.github.io/images/abel-banner.jpg">
  

  <meta property="og:url" content="abelsiqueira.github.io">
  <meta name="twitter:card" content="summary_large_image">

</head>
<body>
  <header>

  <nav class="navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand text-end" href="/julia-tutorial-at-nlesc/"></a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/julia-tutorial-at-nlesc/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/julia-tutorial-at-nlesc/blog/">Blog</a></li>
          <li class="nav-item"><a class="nav-link" href="/julia-tutorial-at-nlesc/julia/">Julia</a></li>
          <li class="nav-item"><a class="nav-link" href="/julia-tutorial-at-nlesc/research/">Research</a></li>
          <li class="nav-item"><a class="nav-link" href="/julia-tutorial-at-nlesc/ufpr/">UFPR</a></li>
        </ul>

        <div class="dark-switch form-check form-switch">
          <input type="checkbox" class="form-check-input" id="darkSwitch" />
          <label class="custom-control-label" for="darkSwitch">Dark Mode</label>
        </div>
        <script src="/julia-tutorial-at-nlesc/libs/dark-mode-switch.min.js"></script>
      </div>

    </div>
  </nav>

</header>



<div class="container-fluid">

  <div class="container main-text">
<!-- Content appended here -->
<div class="franklin-content"><h1>Performance Counters</h1>
<p>FFTW measures execution time in the planning stage, optionally taking advantage of hardware performance counters. This document describes the supported counters and additional steps needed to enable each on different architectures.</p>
<p>See <code>./configure --help</code> for flags for enabling each supported counter. See <a href="kernel/cycle.h">kernel/cycle.h</a> for the code that accesses the counters.</p>
<h1>ARMv7-A &#40;armv7a&#41;</h1>
<h2><code>CNTVCT</code>: Virtual Count Register in VMSA</h2>
<p>A 64-bit counter part of Virtual Memory System Architecture. Section B4.1.34 in ARM Architecture Reference Manual ARMv7-A/ARMv7-R</p>
<p>For access from user mode, requires <code>CNTKCTL.PL0VCTEN &#61;&#61; 1</code>, which must be set in kernel mode on each CPU:</p>
<p>    #define CNTKCTL_PL0VCTEN 0x2 /* B4.1.26 in ARM Architecture Rreference */
    uint32_t r;
    asm volatile&#40;&quot;mrc p15, 0, &#37;0, c14, c1, 0&quot; : &quot;&#61;r&quot;&#40;r&#41;&#41;; /* read */
    r |&#61; CNTKCTL_PL0VCTEN;
    asm volatile&#40;&quot;mcr p15, 0, &#37;0, c14, c1, 0&quot; :: &quot;r&quot;&#40;r&#41;&#41;; /* write */</p>
<p>Kernel module source <em>which can be patched with the above code</em> available at: https://github.com/thoughtpolice/enable<em>arm</em>pmu</p>
<h2><code>PMCCNTR</code>: Performance Monitors Cycle Count Register in VMSA</h2>
<p>A 32-bit counter part of Virtual Memory System Architecture. Section B4.1.113 in ARM Architecture Reference Manual ARMv7-A/ARMv7-R</p>
<p>For access from user mode, requires user-mode access to PMU to be enabled &#40;<code>PMUSERENR.EN &#61;&#61; 1</code>&#41;, which must be done from kernel mode on each CPU:</p>
<p>    #define PERF_DEF_OPTS &#40;1 | 16&#41;
    /* enable user-mode access to counters */
    asm volatile&#40;&quot;mcr p15, 0, &#37;0, c9, c14, 0&quot; :: &quot;r&quot;&#40;1&#41;&#41;;
    /* Program PMU and enable all counters */
    asm volatile&#40;&quot;mcr p15, 0, &#37;0, c9, c12, 0&quot; :: &quot;r&quot;&#40;PERF_DEF_OPTS&#41;&#41;;
    asm volatile&#40;&quot;mcr p15, 0, &#37;0, c9, c12, 1&quot; :: &quot;r&quot;&#40;0x8000000f&#41;&#41;;</p>
<p>Kernel module source with the above code available at: <a href="https://github.com/thoughtpolice/enable_arm_pmu">GitHub thoughtpolice/enable&#95;arm&#95;pmu</a></p>
<p>More information: http://neocontra.blogspot.com/2013/05/user-mode-performance-counters-for.html</p>
<h1>ARMv8-A &#40;aarch64&#41;</h1>
<h2><code>CNTVCT_EL0</code>: Counter-timer Virtual Count Register</h2>
<p>A 64-bit counter, part of Generic Registers. Section D8.5.17 in ARM Architecture Reference Manual ARMv8-A</p>
<p>For user-mode access, requires <code>CNTKCTL_EL1.EL0VCTEN &#61;&#61; 1</code>, which must be set from kernel mode for each CPU:</p>
<p>    #define CNTKCTL_EL0VCTEN 0x2
    uint32_t r;
    asm volatile&#40;&quot;mrs &#37;0, CNTKCTL_EL1&quot; : &quot;&#61;r&quot;&#40;r&#41;&#41;; /* read */
    r |&#61; CNTKCTL_EL0VCTEN;
    asm volatile&#40;&quot;msr CNTKCTL_EL1, &#37;0&quot; :: &quot;r&quot;&#40;r&#41;&#41;; /* write */</p>
<p><em>WARNING</em>: Above code was not tested.</p>
<h2><code>PMCCNTR_EL0</code>: Performance Monitors Cycle Count Register</h2>
<p>A 64-bit counter, part of Performance Monitors. Section D8.4.2 in ARM Architecture Reference Manual ARMv8-A</p>
<p>For access from user mode, requires user-mode access to PMU &#40;<code>PMUSERENR_EL0.EN
&#61;&#61; 1</code>&#41;, which must be set from kernel mode for each CPU:</p>
<p>    #define PERF_DEF_OPTS &#40;1 | 16&#41;
    /* enable user-mode access to counters */
    asm volatile&#40;&quot;msr PMUSERENR_EL0, &#37;0&quot; :: &quot;r&quot;&#40;1&#41;&#41;;
    /* Program PMU and enable all counters */
    asm volatile&#40;&quot;msr PMCR_EL0, &#37;0&quot; :: &quot;r&quot;&#40;PERF_DEF_OPTS&#41;&#41;;
    asm volatile&#40;&quot;msr PMCNTENSET_EL0, &#37;0&quot; :: &quot;r&quot;&#40;0x8000000f&#41;&#41;;
    asm volatile&#40;&quot;msr PMCCFILTR_EL0, &#37;0&quot; :: &quot;r&quot;&#40;0&#41;&#41;;</p>
<p>Kernel module source with the above code available at: <a href="https://github.com/rdolbeau/enable_arm_pmu">GitHub rdolbeau/enable&#95;arm&#95;pmu</a> or in <a href="https://github.com/thoughtpolice/enable_arm_pmu/pull/2">Pull Request #2 at thoughtpolice/enable&#95;arm&#95;pmu</a></p>
</div><!-- CONTENT ENDS HERE -->
</div>
</div>
</div>

<footer>
<div class="container text-center social-footer">
    <a href="mailto:abel.s.siqueira@gmail.com">
        <i class="fas fa-2x fa-envelope" aria-hidden="true"></i>
    </a><a href="https://github.com/abelsiqueira">
        <i class="fab fa-2x fa-github-square" aria-hidden="true"></i>
    </a><a href="https://linkedin.com/in/abel-siqueira/">
        <i class="fab fa-2x fa-linkedin" aria-hidden="true"></i>
    </a><a href="https://twitter.com/abel_siqueira">
        <i class="fab fa-2x fa-twitter-square" aria-hidden="true"></i>
    </a><a href="https://www.researchgate.net/profile/Abel_Siqueira">
        <i class="fab fa-2x fa-researchgate" aria-hidden="true"></i>
    </a><a href="http://orcid.org/0000-0003-4451-281X">
        <i class="fab fa-2x fa-orcid" aria-hidden="true"></i>
    </a>
</div>
</footer>



<script src="/julia-tutorial-at-nlesc/libs/highlight/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();hljs.configure({tabReplace: '    '});</script>


<script src="/julia-tutorial-at-nlesc/libs/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/d17d5e5245.js" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://cdn.rawgit.com/pcooksey/bibtex-js/ef59e62c/src/bibtex_js.js"></script>
</body>

</html>